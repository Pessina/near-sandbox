INPUTS

auth: 0x0000000000000000000000000000000000000000000000000000000000000040baf7afd06ef6b9cbe9ae8ff06724e33014631b9ce01be6bfb2f4c77084317fb40000000000000000000000000000000000000000000000000000000000000041b3ff5014be6df058155423b518e854860b1289b98f996d3ca3ce5d8db895b54463d8c00ba3a4668151eec28d9eae2081a3326856f8d5dbb06889186ed413fd1b0100000000000000000000000000000000000000000000000000000000000000

sender: 0x889E6a9d863373A7A735AB71Cd481e63ef8d64A4

kernelReponse: 0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000001320000000000000000000000000000000000000000000000000000000000000000a302e30303030303337370000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000003c000000000000000000000000000000000000000000000000000000000000013a1000000000000000000000000000000000000000000000000000000000000139e000000000000000000000000000000000000000000000000000000000000137400000000000000000000000000000000000000000000000000000000000013740000000000000000000000000000000000000000000000000000000000000a6a000000000000000000000000000000000000000000000000000000000000000a302e303035313733343700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a302e303030303034303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000007a12000000000000000000000000000000000000000000000000000000000000000403065666434363237643363393735613564353833636232326663333664643538653533383163386136633930636238366364356539643566306138316630643000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000e35f000000000000000000000000000000000000000000000000000000006760365e0000000000000000000000000000000000000000000000000000000000000040303030303030303036663838366661636131363362356433316633663361373734396136363662366433336638393739363130633063613739633236626439610000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000720000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002b9000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000af0000000000000000000000000000000000000000000000000000000000000d80000000000000000000000000000000000000000000000000000000000000004030656664343632376433633937356135643538336362323266633336646435386535333831633861366339306362383663643565396435663061383166306430000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000360000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000fffffffd00000000000000000000000000000000000000000000000000000000000000403136663266666166623833646437343535336231366461333037396365623931306132626264363565363236356462363562666538363439633362326230373100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000001980421f3000000000000000000000000000000000000000000000000000000000000002c30303134363237333761376337613431373133653266383139326330663631303861346337656563623361340000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003d4f505f30204f505f5055534842595445535f32302036323733376137633761343137313365326638313932633066363130386134633765656362336134000000000000000000000000000000000000000000000000000000000000000000000976305f703277706b680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a7462317176666568356c72366739636e757475706a7471307679793266336c77657661796b34777936670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000008e333034343032323031393462333233376336346637326539376538353036313835376163663639386538656433633237643132393764353961366332326136643432393333393234303232303439666264656163313839323732626137616537353132313464333764316566646337633061616464646666616461633434653738363064636463376465373230310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042303265353838343137303930363132353034656562656237616230633665623335633639343634613832386431376462366636353839393039643838653735383838000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000260000000000000000000000000000000000000000000000000000000000000046000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000197fc8024000000000000000000000000000000000000000000000000000000000000002c30303134636263646663663866343563396363346262333833393163383638313763363439356232666135330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003d4f505f30204f505f5055534842595445535f32302063626364666366386634356339636334626233383339316338363831376336343935623266613533000000000000000000000000000000000000000000000000000000000000000000000976305f703277706b680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a746231716530786c65373835746a7776667765633879776764717475766a326d39376a6e6e616e74766c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000007a120000000000000000000000000000000000000000000000000000000000000002c30303134626435373362643638636166336531316164653365313330626430363331636361336262613866320000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003d4f505f30204f505f5055534842595445535f32302062643537336264363863616633653131616465336531333062643036333163636133626261386632000000000000000000000000000000000000000000000000000000000000000000000976305f703277706b680000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a746231716834746e6834357634756c70727430727579637436703333656a336d6832386a73643635366b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000323661313736363631373536333635373432653734363537333734366536353734333432653634363537363230373437383665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000484f505f52455455524e204f505f5055534842595445535f3233203636363137353633363537343265373436353733373436653635373433343265363436353736323037343738366500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000096f705f72657475726e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000e35f000000000000000000000000000000000000000000000000000000006760365e000000000000000000000000000000000000000000000000000000000000004030303030303030303666383836666163613136336235643331663366336137373439613636366236643333663839373936313063306361373963323662643961000000000000000000000000000000000000000000000000000000000000000a302e303030303030393900000000000000000000000000000000000000000000

utxoPubKey: 0x0267ec0b1f94cea5a22511f0925e27fd7de087dfe13d4abe243ded4c94b1573ff0

-------

OUTPUT

should see recover suceful

-------

FUNCTION

func testDecodeAuth(auth []byte, sender common.Address, kernelResponse []byte, utxoPubKey []byte) error {
	log.Printf("test decoding auth")

	signatureTokenType, _ := abi.NewType("bytes", "", nil)
	nonceType, _ := abi.NewType("bytes32", "", nil)

	authArgs := abi.Arguments{
		{Type: signatureTokenType},
		{Type: nonceType},
	}

	unpacked, err := authArgs.Unpack(auth)
	if err != nil {
		log.Printf("Error unpacking auth: %v", err)
		return err
	}

	signatureToken, nonce := unpacked[0], unpacked[1]
	signatureTokenBytes, ok := signatureToken.([]byte)
	if !ok {
		return errors.New("signature token is not a byte array")
	}

	// Convert nonce to bytes32
	var nonceBytes [32]byte
	nonceArray, ok := nonce.([32]byte)
	if !ok {
		return errors.New("nonce is not a byte array")
	}
	copy(nonceBytes[:], nonceArray[:])

	log.Printf("signatureToken: 0x%s", hex.EncodeToString(signatureTokenBytes))
	log.Printf("nonce: %s", common.BytesToHash(nonceBytes[:]).Hex())
	log.Printf("kernelResponse: 0x%s", hex.EncodeToString(kernelResponse))

	// Recreate data digest that was signed
	kernelResponsesDigest := crypto.Keccak256Hash(kernelResponse)
	dataDigest := crypto.Keccak256(sender.Bytes(), common.BytesToHash(nonceBytes[:]).Bytes(), kernelResponsesDigest.Bytes(), utxoPubKey)

	// Recover public key from signature
	pubKeyBytes, err := crypto.Ecrecover(dataDigest, signatureTokenBytes)
	if err != nil {
		log.Printf("Error recovering public key: %v", err)
		return err
	}

	// Convert to public key
	pubKey, err := crypto.UnmarshalPubkey(pubKeyBytes)
	if err != nil {
		log.Printf("Error unmarshaling public key: %v", err)
		return err
	}

	// Get address from public key
	recoveredAddr := crypto.PubkeyToAddress(*pubKey)

	// Compare with address from sender
	log.Printf("recoveredAddr: %s", recoveredAddr.String())
	log.Printf("sender: %s", sender.String())

	if recoveredAddr == sender {
		log.Printf("signature verification successful")
	} else {
		log.Printf("signature verification failed")
		return errors.New("signature verification failed")
	}

	kernelRespType, err := abi.NewType("tuple", "", []abi.ArgumentMarshaling{
		{Name: "price", Type: "string"},
		{Name: "transaction", Type: "bool"},
		{Name: "liquidity", Type: "tuple", Components: []abi.ArgumentMarshaling{
			{Name: "balance", Type: "string"},
			{Name: "sufficient", Type: "bool"},
			{Name: "required_amount", Type: "string"},
			{Name: "utxos", Type: "tuple[]", Components: []abi.ArgumentMarshaling{
				{Name: "TxID", Type: "string"},
				{Name: "vout", Type: "uint256"},
				{Name: "status", Type: "tuple", Components: []abi.ArgumentMarshaling{
					{Name: "confirmed", Type: "bool"},
					{Name: "block_hash", Type: "string"},
					{Name: "block_height", Type: "uint256"},
					{Name: "block_time", Type: "uint256"},
				}},
				{Name: "value", Type: "uint256"},
			}},
			{Name: "transactions", Type: "tuple[]", Components: []abi.ArgumentMarshaling{
				{Name: "TxID", Type: "string"},
				{Name: "version", Type: "uint256"},
				{Name: "locktime", Type: "uint256"},
				{Name: "vin", Type: "tuple[]", Components: []abi.ArgumentMarshaling{
					{Name: "TxID", Type: "string"},
					{Name: "vout", Type: "uint256"},
					{Name: "prevout", Type: "tuple", Components: []abi.ArgumentMarshaling{
						{Name: "ScriptPubKey", Type: "string"},
						{Name: "ScriptPubKeyAsm", Type: "string"},
						{Name: "ScriptPubKeyType", Type: "string"},
						{Name: "ScriptPubKeyAddr", Type: "string"},
						{Name: "Value", Type: "uint256"},
					}},
					{Name: "ScriptSig", Type: "string"},
					{Name: "ScriptSigAsm", Type: "string"},
					{Name: "Witness", Type: "string[]"},
					{Name: "IsCoinbase", Type: "bool"},
					{Name: "Sequence", Type: "uint256"},
				}},
				{Name: "vout", Type: "tuple[]", Components: []abi.ArgumentMarshaling{
					{Name: "ScriptPubKey", Type: "string"},
					{Name: "ScriptPubKeyAsm", Type: "string"},
					{Name: "ScriptPubKeyType", Type: "string"},
					{Name: "ScriptPubKeyAddr", Type: "string"},
					{Name: "Value", Type: "uint256"},
				}},
				{Name: "size", Type: "uint256"},
				{Name: "weight", Type: "uint256"},
				{Name: "SigOps", Type: "uint256"},
				{Name: "fee", Type: "uint256"},
				{Name: "status", Type: "tuple", Components: []abi.ArgumentMarshaling{
					{Name: "confirmed", Type: "bool"},
					{Name: "block_hash", Type: "string"},
					{Name: "block_height", Type: "uint256"},
					{Name: "block_time", Type: "uint256"},
				}},
			}},
			{Name: "fees", Type: "tuple", Components: []abi.ArgumentMarshaling{
				{Name: "fastestFee", Type: "uint256"},
				{Name: "halfHourFee", Type: "uint256"},
				{Name: "hourFee", Type: "uint256"},
				{Name: "economyFee", Type: "uint256"},
				{Name: "minimumFee", Type: "uint256"},
			}},
		}},
		{Name: "premium", Type: "string"},
	})
	if err != nil {
		log.Printf("Error creating kernel response type: %v", err)
		return err
	}

	kernelRespArgs := abi.Arguments{
		{Type: kernelRespType, Name: "kernelResp"},
	}

	unpacked, err = kernelRespArgs.Unpack(kernelResponse)
	if err != nil {
		log.Printf("Error unpacking kernel response: %v", err)
		return err
	}

	prettyJSON, err := json.MarshalIndent(unpacked, "", "    ")
	if err != nil {
		log.Printf("Error marshaling kernel response: %v", err)
		return err
	}
	log.Printf("Decoded kernel response:\n%s", string(prettyJSON))

	return nil
}